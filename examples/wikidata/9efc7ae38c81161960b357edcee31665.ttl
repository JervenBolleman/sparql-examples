@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix dcterms: <http://purl.org/dc/terms/> .
@prefix schema: <https://schema.org/> .

<https://www.wikidata.org/#query-9efc7ae38c81161960b357edcee31665> a sh:SPARQLExecutable,
    sh:SPARQLSelectExecutable;
  sh:select """# Each composer’s most used tonality, with number of works in that tonality.
# (If this is ambiguous – multiple tonalities with the same number – there are multiple results for one composer.)
#
# The SPARQL for this is an evil perversion of three subqueries (one of them nested in another).
# To understand it, you have to go inside out… follow the numbers.

SELECT ?composerLabel ?tonalityLabel ?count
WHERE
{
  {
    # 4. Group again, this time just by the composer.
    #    We also select the highest count of a tonality.
    #    Notice that we don’t know what tonality this count is associated with – we’ll get to that.
    #    So now we have each composer, along with how often they used whatever tonality they used most.
    SELECT ?composer (MAX(?count) AS ?count_)
    WHERE
    {
      {
        # 2. Group by composer and tonality, so that for each composer and tonality, we get a count of how often the composer used this tonality.
        SELECT ?composer ?tonality (COUNT(?composition) AS ?count)
        WHERE
        {
          # 1. Extremely straightforward: the ?composition has the composer ?composer and the tonality ?tonality.
          #    (I’m not bothering with any “instance of” because the presence of these two properties is a sufficient indicator of ?composition being a composition.)
          ?composition wdt:P86 ?composer;
                       wdt:P826 ?tonality.
        }
        GROUP BY ?composer ?tonality
        HAVING(?count > 1) # 3. Limit that to counts > 1, because using a tonality once is hardly “most used”.
      }
    }
    GROUP BY ?composer
  }
  {
    # 6. Identical to 2.
    SELECT ?composer ?tonality (COUNT(?composition) AS ?count)
    WHERE
    {
      # 5. Identical to 1.
      ?composition wdt:P86 ?composer;
                   wdt:P826 ?tonality.
    }
    GROUP BY ?composer ?tonality
    HAVING(?count > 1) # 7. Identical to 3.
  }
  # 8. That’s it. Wait, what?
  #    From 4, we now have ?composer, any composer, and ?count, the count of how often they used whatever tonality they used most.
  #    From 6, we also have a ?composer, as well as a ?tonality, and the count of how often they used that particular tonality.
  #    The trick is that ?composer and ?count are the same variable in each subquery, and so now, when the two subqueries are joined,
  #    we select only that ?tonality from 6 where the ?composer and the ?count are identical to those from 4 –
  #    that is, where this tonality was used as often as the composer’s most-used tonality.
  #    In other words, this must *be* the composer’s most-used tonality (except when there are multiple tonalities with the same count).
  SERVICE wikibase:label { bd:serviceParam wikibase:language \"en\". }
}
ORDER BY DESC(?count) # 9. Order by count (highest first), because the result isn’t very meaningful for low counts (many compositions aren’t on Wikidata or don’t have a tonality statement).""";
  dcterms:isPartOf <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/lb>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/th>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/eu>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/en-gb>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/vec>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/hy>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/id>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/be-tarask>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/tr>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ro>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/he>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/zh>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/pt-br>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/si>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/eo>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/da>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ar>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ko>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/pl>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ms>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/sv>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/lt>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/nl>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ca>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/uk>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/it>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ja>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/es>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/cs>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/ru>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/de>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/fr>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples/en>,
    <https://www.wikidata.org//wiki/Wikidata:SPARQL_query_service/queries/examples>;
  dcterms:license <https://creativecommons.org/licenses/by-sa/4.0/>;
  sh:prefixes _:wikidata_prefixes, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-wikidata_prefixes,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-DA0F407A5C00A39F2A3F4FA54D1B49B4, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-1823E8E59F1217BDD1C315FED6C591E6,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-3ED0A6AF4628FDE7DF73ADC4D9DED49A, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-F092537697B0943C4230289E0C223045,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-6972EEB6043F35D1D443254523DB6584, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-5495079EB063982F02FAC9F4AEC6F0F4,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-C8C0EE4DB5E98FB86AEA3BBBC94CC756, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-195D01773DC5DF2915DF3E4980A201B0,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-C66199D09D50DB33E5A5DEC66D55DCB1, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-AFBF9BEAFF08213A36747336E9FCC668,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-3B874292140F48657BE603EF56698785, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-825235D412B43FFBB0280E4579A3A7B2,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-6DA692D8A4FA4B58BC4731C3AD487F69, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-B5A32E29DEF45BB0EE2F979F82CEE397,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-68D2EF67C3B9BA2D5D56E92FBE108E5F, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-42BD2C154D82A5F5E013841E8C4ABFA3,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-A989C887DBB1EF10C0FB5514CD7A58C9, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-E4208D65A7A57529DC74DF51B556CD20,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-330AEEB99905A112B85F073C86564839, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-7B80322FBE4AFC8F465F3E207ACFA529,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-72CB242FBCAFA1C14FE0D95AD86671C3, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-0B4A3361C472558A25BF91DD2E4F10EE,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-A3AEC173678357964D8BA15241DEFDB6, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-63E0C61C4014C0600DE9227188FF619B,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-B8155C6B37D209842784FBC533732268, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-8A7C0EB47A49714A55E02E2604BEC08F,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-848FE90FD1DD5CC6B0CDDD9EA257D0E5, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-E92A2C243FB61F515681C02641C9FD16,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-8F2E64F6057D0AB31BA5C1A54C533912, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-B620F4754AF4520007C397E38344419A,
    _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-47932B7F120CF0F9E07BBA55CA31214D, _:genid-9eb55b2583ef4ad09d9d48ff9f18ffec116303-426726D2C461B8823E517051A401F1AA;
  schema:target <https://query.wikidata.org/sparql/> .
